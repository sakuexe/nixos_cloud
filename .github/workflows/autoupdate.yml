name: Update flake.lock

on:
  schedule:
    # runs on 02:19
    - cron: "19 2 * * *"
  workflow_dispatch:

# Needed to push to the repo using GITHUB_TOKEN
permissions:
  contents: write

# Prevent overlapping runs (e.g. if one is slow and the next schedule starts)
concurrency:
  group: update-flake-lock
  cancel-in-progress: true

jobs:
  update-and-push:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.diff.outputs.changed }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # checkout sets up auth so `git push` can work with GITHUB_TOKEN
          fetch-depth: 0

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v12

      - name: Enable Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v7

      - name: Capture toplevel closures (before)
        id: before
        run: |
          set -euo pipefail

          # List nixosConfigurations names from the flake
          nix flake show --json \
            | jq -r '.nixosConfigurations | keys[]' > hosts.txt

          echo "Detected configurations:"
          cat hosts.txt

          mkdir -p closures/before
          while read -r host; do
            echo "Building BEFORE for $host"
            path=$(nix build --no-link --print-out-paths ".#nixosConfigurations.${host}.config.system.build.toplevel")
            echo "$path" > "closures/before/${host}"
          done < hosts.txt

      - name: Update flake.lock
        run: nix flake update

      - name: Detect changes
        id: diff
        run: |
          if git diff --quiet -- flake.lock; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Capture toplevel closures (after)
        if: steps.diff.outputs.changed == 'true'
        id: after
        run: |
          set -euo pipefail
          mkdir -p closures/after
          while read -r host; do
            echo "Building AFTER for $host"
            path=$(nix build --no-link --print-out-paths ".#nixosConfigurations.${host}.config.system.build.toplevel")
            echo "$path" > "closures/after/${host}"
          done < hosts.txt

      - name: Job summary (all NixOS configurations)
        if: steps.diff.outputs.changed == 'true'
        run: |
          set -euo pipefail

          echo "## ðŸ“¦ Package changes by NixOS configuration" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          while read -r host; do
            before=$(cat "closures/before/${host}")
            after=$(cat "closures/after/${host}")

            echo "### ${host}" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "- **Before:** \`${before}\`" >> "$GITHUB_STEP_SUMMARY"
            echo "- **After:**  \`${after}\`" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            nix store diff-closures "$before" "$after" >> "$GITHUB_STEP_SUMMARY" || true
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
          done < hosts.txt
