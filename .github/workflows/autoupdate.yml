name: Update flake.lock

on:
  schedule:
    # runs at 02:19, Helsinki time
    # - cron: "19 0 * * *" # summer
    - cron: "19 23 * * *" # winter
  workflow_dispatch:

# needed to push to the repo using GITHUB_TOKEN
permissions:
  contents: write

# prevent overlapping runs
concurrency:
  group: update-flake-lock
  cancel-in-progress: true

jobs:
  check-for-changes:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.diff.outputs.changed }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update flake.lock
        run: nix flake update

      - name: Detect changes
        id: diff
        run: |
          if git diff --quiet -- flake.lock; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

  update-and-push:
    needs: check-for-changes
    if: needs.check-for-changes.outputs.changed == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # checkout sets up auth so `git push` can work with GITHUB_TOKEN
          fetch-depth: 0

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Capture toplevel closures (before)
        id: before
        run: |
          set -euo pipefail

          nix flake show --json \
            | jq -r '.nixosConfigurations | keys[]' > hosts.txt

          echo "Detected configurations:"
          cat hosts.txt

          mkdir -p closures/before
          while read -r host; do
            echo "Building BEFORE for $host"
            path=$(nix build --no-link --print-out-paths ".#nixosConfigurations.${host}.config.system.build.toplevel")
            echo "$path" > "closures/before/${host}"
          done < hosts.txt

      - name: Update flake.lock
        run: nix flake update

      - name: Capture toplevel closures (after)
        id: after
        run: |
          set -euo pipefail
          mkdir -p closures/after
          while read -r host; do
            echo "Building AFTER for $host"
            path=$(nix build --no-link --print-out-paths ".#nixosConfigurations.${host}.config.system.build.toplevel")
            echo "$path" > "closures/after/${host}"
          done < hosts.txt

      - name: Commit & push (only if changed)
        run: |
          git config user.name "nixos-cloud-bot"
          git config user.email "nixos-cloud-bot@users.noreply.github.com"

          git add flake.lock
          git commit -m "chore: update flake.lock"
          git push origin HEAD:main

      - name: Job summary (all NixOS configurations)
        run: |
          set -euo pipefail

          echo "## ðŸ“¦ Package changes by NixOS configuration" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          while read -r host; do
            before=$(cat "closures/before/${host}")
            after=$(cat "closures/after/${host}")

            echo "### ${host}" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "- **Before:** \`${before}\`" >> "$GITHUB_STEP_SUMMARY"
            echo "- **After:**  \`${after}\`" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"

            diff_output="$(nix store diff-closures "$before" "$after" || true)"

            if [ -z "$diff_output" ]; then
              echo "no changes" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "$diff_output" >> "$GITHUB_STEP_SUMMARY"
            fi

            echo '```' >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
          done < hosts.txt
